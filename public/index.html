<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sentient Mosaic</title>
  <style>
    :root {
      --bg: #000;          /* arka plan siyah */
      --tile: #0ea5e9;     /* logo içi karo rengi (cyan) */
      --grid: #1b2530;     /* ince kılavuz rengi (çok koyu) */
    }
    html, body {
      margin: 0;
      height: 100%;
      background: var(--bg);
      color: #cbd5e1;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap {
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 16px;
      box-sizing: border-box;
    }
    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      width: min(1200px, 96vw);
      justify-content: center;
    }
    .pill {
      padding: 6px 10px;
      border-radius: 10px;
      background: #111827;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      font-size: 12px;
    }
    .btn {
      background: #6366f1;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .stage {
      width: min(1200px, 96vw);
      aspect-ratio: 1 / 1;
      position: relative;
      border-radius: 16px;
      border: 1px dashed #334155;
      overflow: hidden;
      background: #000; /* logo dışı alanlar zaten siyah kalacak */
      box-shadow: 0 0 0 1px #0b1220 inset;
    }
    canvas { width: 100%; height: 100%; display:block; }
    .hint {
      font-size: 12px;
      color: #94a3b8;
      opacity: .8;
      text-align: center;
    }
    .badge {
      font-size: 11px; background:#111827; border:1px solid #1f2937; padding:2px 8px; border-radius:999px;
    }
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <span class="pill">Topluluk profillerinden piksel mozaik — <span id="cfgSource" class="badge">yükleniyor…</span></span>
      <button id="btnRedraw" class="btn" disabled>Yeniden çiz</button>
    </div>

    <div class="stage">
      <canvas id="gridCanvas"></canvas>
    </div>

    <div class="hint">
      Logo dışı alan siyah, logo içi hücreler yuvarlatılmış karolar olarak çizilir. (Veri: <code>settings/config</code>)
    </div>
  </div>

  <script>
    /************* 1) Firebase init (KENDİ PROJE AYARLARINIZI DOLDURUN) *************/
    const firebaseConfig = {
      /* SİZE AİT CONFIG */
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      // vs...
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /************* 2) Global durum *************/
    const state = {
      cfg: null,          // firestore config
      maskImg: null,      // HTMLImageElement
      isReady: false,     // her şey yüklendi mi?
      maskReady: false,   // maske offscreen’a işlendi mi?
      isSolid: null       // (r,c) -> boolean (logo içi mi?)
    };

    const els = {
      canvas: document.getElementById('gridCanvas'),
      btnRedraw: document.getElementById('btnRedraw'),
      cfgSource: document.getElementById('cfgSource'),
    };
    const ctx = els.canvas.getContext('2d');

    /************* 3) Yardımcılar *************/
    function roundRectPath(ctx, x, y, w, h, r) {
      r = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r);
      ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r);
      ctx.closePath();
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        // Cache-bust, CDN/Vercel’de 304 olsa da data güncel kalsın:
        img.src = src + (src.includes('?') ? '&' : '?') + 'v=' + Date.now();
        img.onload = () => resolve(img);
        img.onerror = (e) => reject(e);
      });
    }

    async function loadConfig() {
      const snap = await db.collection('settings').doc('config').get();
      const data = snap.exists ? snap.data() : {};
      // Varsayılanlar
      const cfg = {
        gridCols: Number(data.gridCols) || 40,
        gridRows: Number(data.gridRows) || 40,
        cellPx:  Number(data.cellPx)  || 16,
        logoMaskUrl: data.logoMaskUrl || '/mask.png',
        mosaicOpen: data.mosaicOpen !== false,
        maxClaimPerUser: Number(data.maxClaimPerUser || 1)
      };
      state.cfg = cfg;
      els.cfgSource.textContent = 'Firestore';
      console.log('CFG source: firestore');
      console.log('Mask URL :', cfg.logoMaskUrl);
      return cfg;
    }

    function buildMaskBitmap() {
      const {gridCols, gridRows, cellPx} = state.cfg;
      // Offscreen boyut: grid çözünürlüğü (pürüzsüz eşleme)
      const W = gridCols * cellPx;
      const H = gridRows * cellPx;
      const off = document.createElement('canvas');
      off.width = W; off.height = H;
      const octx = off.getContext('2d');

      // Arka plan beyaz, maske siyah (mask.png öyle)
      octx.fillStyle = '#fff';
      octx.fillRect(0,0,W,H);

      const img = state.maskImg;
      // contain
      const scale = Math.min(W / img.width, H / img.height);
      const dw = img.width * scale;
      const dh = img.height * scale;
      const dx = (W - dw) / 2;
      const dy = (H - dh) / 2;
      octx.drawImage(img, dx, dy, dw, dh);

      const data = octx.getImageData(0,0,W,H).data;

      // Hücre merkezinden alpha örnekle: alpha < 128 => siyah kısım (logo içi)
      state.isSolid = (r,c) => {
        const cx = Math.floor((c + 0.5) * cellPx);
        const cy = Math.floor((r + 0.5) * cellPx);
        const idx = (cy * W + cx) * 4 + 3;   // alpha kanalı
        const a = data[idx] ?? 255;
        return a < 128;
      };

      state.maskReady = true;
      console.log('mask ready', {W,H,dw,dh,dx,dy});
    }

    function setCanvasToGridSize() {
      const {gridCols, gridRows, cellPx} = state.cfg;
      els.canvas.width = gridCols * cellPx;
      els.canvas.height = gridRows * cellPx;
    }

    function draw() {
      if (!state.cfg || !state.maskReady) return;

      setCanvasToGridSize();
      const {gridCols, gridRows, cellPx} = state.cfg;

      // Arka plan (logo dışı siyah)
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, els.canvas.width, els.canvas.height);

      // İsteğe bağlı çok hafif grid kılavuzu
      ctx.strokeStyle = 'rgba(51,65,85,.25)';
      ctx.lineWidth = 1;
      for (let x = 0; x <= gridCols; x++) {
        const px = x * cellPx + .5;
        ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, els.canvas.height); ctx.stroke();
      }
      for (let y = 0; y <= gridRows; y++) {
        const py = y * cellPx + .5;
        ctx.beginPath(); ctx.moveTo(0, py); ctx.lineTo(els.canvas.width, py); ctx.stroke();
      }

      // Logo içi hücreler: yuvarlatılmış karolar
      const pad = Math.max(1, Math.floor(cellPx * 0.12));     // iç boşluk
      const r   = Math.floor(cellPx * 0.35);                   // köşe yarıçapı
      ctx.fillStyle = getComputedStyle(document.documentElement)
                      .getPropertyValue('--tile').trim() || '#0ea5e9';

      for (let rrow = 0; rrow < gridRows; rrow++) {
        for (let ccol = 0; ccol < gridCols; ccol++) {
          if (state.isSolid(rrow, ccol)) {
            const x = ccol * cellPx + pad;
            const y = rrow * cellPx + pad;
            const w = cellPx - pad * 2;
            const h = cellPx - pad * 2;
            roundRectPath(ctx, x, y, w, h, r);
            ctx.fill();
          }
        }
      }
    }

    async function boot() {
      try {
        els.btnRedraw.disabled = true;
        const cfg = await loadConfig();
        state.maskImg = await loadImage(cfg.logoMaskUrl);
        buildMaskBitmap();
        draw();
        els.btnRedraw.disabled = false;
      } catch (err) {
        console.error(err);
        els.cfgSource.textContent = 'Hata';
      }
    }

    /************* 4) Olaylar *************/
    window.addEventListener('load', boot);
    els.btnRedraw.addEventListener('click', () => draw());
    // (Boyut değişse de canvas kendi grid boyutunda; CSS ile orantılı büyüyüp küçülür)

  </script>
</body>
</html>
