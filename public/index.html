<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sentient Mosaic</title>
  <style>
    :root{
      --bg:#0a0a0a; --panel:#111318; --text:#e5e7eb; --muted:#9aa0a6; --accent:#6366f1; --logo:#0ea5e9;
      --ring:rgba(255,255,255,.75);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:#000;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      display:flex;flex-direction:column;align-items:center;gap:10px;padding-bottom:24px;
    }
    .toolbar{
      width:min(1200px,95vw);display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;
      padding:10px;margin-top:10px;background:var(--panel);border:1px solid #1f2430;border-radius:12px;
    }
    .toolbar input[type="text"]{background:#0f1115;color:var(--text);border:1px solid #242a36;border-radius:8px;padding:8px 10px;min-width:160px}
    .toolbar input[type="file"]{color:var(--muted)}
    .toolbar button{background:#5046e4;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .toolbar .ghost{background:#1b1e27;color:var(--text)}
    .hint{color:var(--muted);font-size:12px;text-align:center;margin-top:-2px}
    .stage{width:min(1200px,95vw);background:#0b0b0b;border:1px dashed #2a2f3b;border-radius:12px;padding:8px;
      display:flex;justify-content:center;align-items:center}
    canvas{display:block;background:#000;border-radius:10px}
    .legend{color:var(--muted);font-size:12px;text-align:center;margin-top:-6px}
    .status{font-size:12px;color:#fca5a5;text-align:center;min-height:18px}
    .dlg-back{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10}
    .dlg{width:min(520px,92vw);background:#0f1115;border:1px solid #2a3245;border-radius:12px;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.55)}
    .dlg h3{margin:0 0 8px 0;font-size:16px}
    .row{display:flex;gap:8px;margin:8px 0}
    .row input[type="text"], .row input[type="file"]{flex:1;background:#0b0d12;border:1px solid #263044;border-radius:8px;color:var(--text);padding:8px}
    .dlg .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .ok{background:#5046e4;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .cancel{background:#1b1e27;color:#e5e7eb;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .good{color:#34d399}
  </style>

  <!-- Firebase compat SDK'leri -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.1/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.1/firebase-storage-compat.js"></script>
</head>
<body>

  <div class="toolbar">
    <input id="tw" type="text" placeholder="@twitter (zorunlu)" />
    <input id="note" type="text" placeholder="Sentient’e notun (max 128)" maxlength="128" style="flex:1;min-width:220px" />
    <input id="file" type="file" accept="image/png,image/jpeg,image/webp" />
    <button id="clearSel" class="ghost">Seçimi temizle</button>
    <button id="placeSel">Seçilen hücreye yerleştir</button>
  </div>
  <div class="hint">Sadece <b>mavi logo</b> piksellerine tıklayıp yerleştirebilirsin. İlk tık seçer, butonla kaydedersin.</div>

  <div class="stage">
    <canvas id="mosaic" aria-label="mosaic"></canvas>
  </div>
  <div id="status" class="status"></div>
  <div class="legend">Mavi daireler logo piksellerini temsil eder. (Ayar: <code>settings/config</code>)</div>

  <!-- Mini Dialog -->
  <div id="dlgBack" class="dlg-back">
    <div class="dlg">
      <h3>Hücresi Sahiplen</h3>
      <div class="row"><input id="dlgTw" type="text" placeholder="@twitter (zorunlu)"></div>
      <div class="row"><input id="dlgNote" type="text" placeholder="Kısa not (max 128)" maxlength="128"></div>
      <div class="row"><input id="dlgFile" type="file" accept="image/png,image/jpeg,image/webp"></div>
      <div class="actions">
        <button id="dlgCancel" class="cancel">Vazgeç</button>
        <button id="dlgSave" class="ok">Kaydet</button>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   0) Firebase init
   ———————————————————————————————————————————————— */
const firebaseConfig = {
  apiKey: "AIzaSyC5wMcRcmXlFy53D1EJ3J8BkIKy3_Fb3OE",
  authDomain: "sentient-mosaic.firebaseapp.com",
  projectId: "sentient-mosaic",
  // ÖNEMLİ: bucket adı -> <project-id>.appspot.com
  storageBucket: "sentient-mosaic.appspot.com",
  messagingSenderId: "270660218350",
  appId: "1:270660218350:web:4882d74709e8bfcbbff27ff",
  measurementId: "G-52B6Y2M6TP"
};

firebase.initializeApp(firebaseConfig);
window.__FB__ = {
  app: firebase.app(),
  auth: firebase.auth(),
  db: firebase.firestore(),
  st: firebase.storage()
};
__FB__.auth.onAuthStateChanged(async u=>{
  if (!u) await __FB__.auth.signInAnonymously().catch(console.error);
});

/* =========================================================
   1) UI & Canvas & Helpers
   ———————————————————————————————————————————————— */
const $ = s => document.querySelector(s);
const statusEl = $('#status');
const canvas = $('#mosaic');
const ctx = canvas.getContext('2d',{ willReadFrequently:true });

const DEFAULT_CFG = {
  gridCols: 40,
  gridRows: 40,
  cellPx: 16,
  logoMaskUrl: '/mask.png',
  mosaicOpen: true,
  maxClaimPerUser: 1
};
let cfg = { ...DEFAULT_CFG };
let maskGrid = null;
let selected = null;
const placementsMap = new Map();

function setCanvasSize(){
  canvas.width  = cfg.gridCols * cfg.cellPx;
  canvas.height = cfg.gridRows * cfg.cellPx;
  const maxW = Math.min(window.innerWidth * 0.95, 1100);
  const scale = Math.min(1, maxW / canvas.width);
  canvas.style.width  = (canvas.width*scale) + 'px';
  canvas.style.height = (canvas.height*scale) + 'px';
}
setCanvasSize(); addEventListener('resize', setCanvasSize);

function paintBackground(){ ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width,canvas.height); }

function imageToGrid(img, rows, cols){
  const t = document.createElement('canvas');
  t.width = cols; t.height = rows;
  const tctx = t.getContext('2d',{ willReadFrequently:true });
  tctx.imageSmoothingEnabled = false;
  tctx.drawImage(img,0,0,cols,rows);
  const data = tctx.getImageData(0,0,cols,rows).data;
  const grid = new Array(rows).fill(0).map(()=>new Array(cols).fill(false));
  for (let y=0;y<rows;y++){
    for (let x=0;x<cols;x++){
      const i=(y*cols+x)*4; const r=data[i],g=data[i+1],b=data[i+2],a=data[i+3];
      const L = 0.2126*r + 0.7152*g + 0.0722*b;
      const isLogo = (a>40) && (L<100);
      grid[y][x] = !!isLogo;
    }
  }
  return grid;
}

function drawGrid(){
  const cell=cfg.cellPx;
  paintBackground();
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--logo').trim()||'#0ea5e9';
  if (maskGrid){
    for (let y=0;y<cfg.gridRows;y++){
      for (let x=0;x<cfg.gridCols;x++){
        if (!maskGrid[y][x]) continue;
        const cx=x*cell+cell/2, cy=y*cell+cell/2, r=Math.floor(cell*0.45);
        ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
      }
    }
  }
  ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1;
  for (let x=0; x<=cfg.gridCols; x++){ ctx.beginPath(); ctx.moveTo(x*cell,0); ctx.lineTo(x*cell,canvas.height); ctx.stroke(); }
  for (let y=0; y<=cfg.gridRows; y++){ ctx.beginPath(); ctx.moveTo(0,y*cell); ctx.lineTo(canvas.width,y*cell); ctx.stroke(); }

  if (selected){
    ctx.strokeStyle='#fff'; ctx.lineWidth=2;
    ctx.strokeRect(selected.x*cell+2, selected.y*cell+2, cell-4, cell-4);
  }
  drawPlacements();
}

const imageCache = new Map();
function drawPlacements(){
  const cell = cfg.cellPx;
  const me = __FB__?.auth?.currentUser?.uid;
  for (const [,p] of placementsMap){
    const cx = p.x*cell + cell/2;
    const cy = p.y*cell + cell/2;
    const r  = Math.floor(cell*0.42);

    if (p.imageUrl){
      let img = imageCache.get(p.imageUrl);
      if (!img){
        img = new Image(); img.crossOrigin='anonymous'; img.src=p.imageUrl;
        imageCache.set(p.imageUrl,img);
        img.onload = ()=> drawPlacements();
      }
      if (img.complete){
        ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.clip();
        ctx.drawImage(img, cx-r, cy-r, r*2, r*2); ctx.restore();
      }
    }else{
      ctx.fillStyle='#fff';
      ctx.beginPath(); ctx.arc(cx,cy,Math.max(2,Math.floor(cell*0.12)),0,Math.PI*2); ctx.fill();
    }

    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.lineWidth = (p.uid===me) ? 3 : 1.5;
    ctx.strokeStyle = (p.uid===me) ? '#fff' : 'rgba(255,255,255,.6)';
    ctx.stroke();
  }
}

/* =========================================================
   2) Config + Mask + Firestore stream
   ———————————————————————————————————————————————— */
async function loadConfig(){
  try{
    const db = __FB__.db;
    const snap = await db.collection('settings').doc('config').get();
    if (snap.exists) Object.assign(cfg, snap.data());
  }catch(e){ console.warn('Firestore config okunamadı, varsayılan kullanılıyor.', e); }
}
async function loadAndRenderMask(){
  statusEl.textContent='';
  const img=new Image(); img.crossOrigin='anonymous';
  return new Promise(res=>{
    img.onload = ()=>{ maskGrid = imageToGrid(img,cfg.gridRows,cfg.gridCols); drawGrid(); res(true); };
    img.onerror = ()=>{ statusEl.textContent='Mask yüklenemedi: '+cfg.logoMaskUrl; drawGrid(); res(false); };
    img.src = cfg.logoMaskUrl || '/mask.png';
  });
}
function startPlacementsStream(){
  const db = __FB__.db;
  db.collection('placements').onSnapshot(s=>{
    placementsMap.clear();
    s.forEach(doc=> placementsMap.set(doc.id, doc.data()));
    drawGrid();
  });
}

/* =========================================================
   3) Seçim & Dialog & Kaydetme
   ———————————————————————————————————————————————— */
const canvasClick = (ev)=>{
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const x = Math.floor((ev.clientX - rect.left) * scaleX / cfg.cellPx);
  const y = Math.floor((ev.clientY - rect.top)  * scaleY / cfg.cellPx);
  if (x<0||y<0||x>=cfg.gridCols||y>=cfg.gridRows) return;
  if (!maskGrid || !maskGrid[y][x]) { statusEl.textContent='Bu hücre logo alanı değil.'; return; }
  selected = {x,y}; drawGrid(); statusEl.textContent=`Seçildi: (${x}, ${y})`;
};
canvas.addEventListener('click', canvasClick);

$('#clearSel').onclick = ()=>{ selected=null; drawGrid(); statusEl.textContent='Seçim temizlendi.'; };

$('#placeSel').onclick = ()=> openDlg();

function openDlg(){
  if (!selected){ statusEl.textContent='Önce mozaikte bir logo hücresi seç.'; return; }
  $('#dlgTw').value = $('#tw').value || '';
  $('#dlgNote').value = $('#note').value || '';
  $('#dlgFile').value = '';
  $('#dlgBack').style.display='flex';
}
$('#dlgCancel').onclick = ()=> $('#dlgBack').style.display='none';
$('#dlgSave').onclick   = async ()=>{
  $('#tw').value  = $('#dlgTw').value.trim();
  $('#note').value= $('#dlgNote').value.trim();
  const f = $('#dlgFile').files[0];
  if (f){ const mainFile=$('#file'); const dt=new DataTransfer(); dt.items.add(f); mainFile.files = dt.files; }
  $('#dlgBack').style.display='none';
  await placeSelected();
};

async function placeSelected(){
  try{
    if (!selected) return;
    if (!cfg.mosaicOpen){ statusEl.textContent='Mosaic kapalı.'; return; }
    const tw = $('#tw').value.trim();
    const note = $('#note').value.trim();
    if (!tw || !tw.startsWith('@')){ statusEl.textContent='@twitter zorunlu.'; return; }

    const {x,y} = selected;
    const uid = __FB__.auth.currentUser?.uid;
    if (!uid){ await __FB__.auth.signInAnonymously(); }

    const db=__FB__.db;
    const docId = `${x}_${y}`;
    const now = Date.now();

    await db.collection('placements').doc(docId).set({
      x, y, tw, note, uid: __FB__.auth.currentUser.uid, ts: now
    });

    await db.collection('claims').doc(__FB__.auth.currentUser.uid).set({
      placed:true, x, y, ts: now
    });

    statusEl.textContent = `Yerleştirildi: (${x}, ${y}) — görsel yükleniyor...`;
    await uploadPlacementImageAndPatch({x,y});
    statusEl.innerHTML = `<span class="good">Tamamlandı</span> — (${x}, ${y})`;

  }catch(err){
    console.error(err);
    statusEl.textContent = err?.message || String(err);
  }
}

async function uploadPlacementImageAndPatch({x,y}){
  const file = $('#file')?.files?.[0];
  if (!file) return;
  const uid = __FB__.auth.currentUser.uid;
  const path = `placements/${x}_${y}/${uid}-${Date.now()}-${file.name}`;
  const ref  = __FB__.st.ref(path);
  await ref.put(file, { contentType:file.type });
  const url = await ref.getDownloadURL();
  await __FB__.db.collection('placements').doc(`${x}_${y}`).update({ imageUrl:url });
}

/* =========================================================
   4) Başlat
   ———————————————————————————————————————————————— */
(async function init(){
  await loadConfig();
  setCanvasSize();
  await loadAndRenderMask();
  startPlacementsStream();
  if (!__FB__?.auth?.currentUser) await __FB__.auth.signInAnonymously().catch(()=>{});
})();
</script>
</body>
</html>
