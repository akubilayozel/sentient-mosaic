<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sentient Mosaic</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0b0f; --panel:#14141b; --muted:#9aa3b2; --text:#e5e7eb;
      --primary:#4f46e5; --primary-2:#6366f1; --ok:#22c55e; --warn:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1200px;margin:16px auto 40px;padding:0 16px}
    h1{font-size:28px;margin:2px 0 12px;text-align:center;font-weight:800}
    .sub{opacity:.9;text-align:center;margin:-2px 0 8px}
    .row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px 0 18px}
    input[type="text"], textarea{
      background:#0f1117;border:1px solid #1f2533;color:var(--text);
      border-radius:10px;padding:10px 12px;outline:none
    }
    input[type="text"]{width:220px}
    textarea{width:320px;height:36px;resize:vertical}
    input[type="file"]{color:var(--muted)}
    button{background:var(--primary);border:0;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button:hover{background:var(--primary-2)}
    .board{background:var(--panel);border:1px dashed #2b3346;border-radius:14px;padding:10px}
    .canvas-wrap{position:relative;border:1px dashed #374055;border-radius:10px;overflow:hidden}
    /* Kanvasları üst üste koyuyoruz */
    .canvas-wrap canvas{position:absolute;left:0;top:0;display:block;image-rendering: pixelated;}
    /* altlık için ayrı bir layer */
    #bgCanvas{z-index:1}
    #gridCanvas{z-index:3}
    #hitCanvas{z-index:2;display:none} /* sadece örnekleme için */

    .zoom{position:absolute;top:6px;right:10px;display:flex;gap:6px;z-index:5}
    .zoom button{padding:4px 10px;border-radius:8px}
    .legend{margin-top:8px;text-align:center;color:var(--muted);font-size:13px}
    .pill{display:inline-flex;gap:6px;align-items:center;font-size:12px;margin:0 4px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .sel{background:#0ea5e9}
    .closed{background:#64748b}
    .taken{background:#ef4444}
    .note{color:var(--muted);text-align:center;margin:8px 0 2px}
    .state-ok{color:var(--ok);font-weight:700}
    .state-off{color:var(--warn);font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Sentient Mosaic</h1>
    <div class="sub">Topluluk profillerinden piksel mozaik —
      <span id="state" class="state-off">…</span>
    </div>

    <div class="row">
      <input id="username" type="text" placeholder="Twitter kullanıcı adı">
      <input id="file" type="file" accept="image/png, image/jpeg">
      <textarea id="note" placeholder="Dobby'e notun (128 karakter)"></textarea>
      <button id="clearSel">Seçimi temizle</button>
      <button id="placeBtn">Seçilen hücreye yerleştir</button>
    </div>

    <p class="note">Bir hücre seçmek için mozaikte <b>logonun siyah alanına</b> tıkla. (Her kullanıcı en fazla 1 hücre alabilir)</p>

    <div class="board">
      <div id="canvasWrap" class="canvas-wrap" style="min-height:400px">
        <!-- Arka plan: soluk logo -->
        <canvas id="bgCanvas"></canvas>
        <!-- Görünmeyen: piksel örnekleme için tam çözünürlükte maske -->
        <canvas id="hitCanvas"></canvas>
        <!-- Grid ve seçim çizimleri -->
        <canvas id="gridCanvas"></canvas>

        <div class="zoom">
          <button id="zoomIn">+</button>
          <button id="zoomOut">–</button>
          <span id="zoomPct" style="margin-left:6px;color:#cbd5e1;font-weight:700">%100</span>
        </div>
      </div>
      <div class="legend">
        Açıklama:
        <span class="pill"><span class="dot sel"></span>Seçilebilir</span>
        <span class="pill"><span class="dot closed"></span>Kapalı (zemin)</span>
        <span class="pill"><span class="dot taken"></span>Dolu</span>
      </div>
    </div>
  </div>

  <!-- Firebase v10 + Uygulama -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ===== Firebase config =====
    const firebaseConfig = {
      apiKey: "AIzaSyC5wMcRcmXlFy53D1EJ3J8BkIKy3_Fb3OE",
      authDomain: "sentient-mosaic.firebaseapp.com",
      projectId: "sentient-mosaic",
      storageBucket: "sentient-mosaic.firebasestorage.app",
      messagingSenderId: "270660218350",
      appId: "1:270660218350:web:4882d74709e8bfcbff72ff",
      measurementId: "G-526BY2M6TP"
    };

    // ===== DOM kısa yollar =====
    const els = {
      state: document.getElementById('state'),
      username: document.getElementById('username'),
      file: document.getElementById('file'),
      note: document.getElementById('note'),
      clearSel: document.getElementById('clearSel'),
      placeBtn: document.getElementById('placeBtn'),
      bg: document.getElementById('bgCanvas'),
      hit: document.getElementById('hitCanvas'),
      grid: document.getElementById('gridCanvas'),
      wrap: document.getElementById('canvasWrap'),
      zoomIn: document.getElementById('zoomIn'),
      zoomOut: document.getElementById('zoomOut'),
      zoomPct: document.getElementById('zoomPct'),
    };

    // ===== Durum =====
    let CFG = { cellPx:16, gridRows:40, gridCols:40, logoMaskUrl:"/mask.png", mosaicOpen:true };
    let scale = 1;
    let selectable = [];          // boolean gridRows x gridCols
    let taken = new Set();        // (şimdilik boş)
    let picked = null;            // [r,c]

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const bgCtx   = els.bg.getContext('2d');
    const hitCtx  = els.hit.getContext('2d');
    const gridCtx = els.grid.getContext('2d');

    function canvasWH(){ return [CFG.gridCols * CFG.cellPx, CFG.gridRows * CFG.cellPx]; }

    function setCanvasSize() {
      const [W,H] = canvasWH();
      [els.bg, els.hit, els.grid].forEach(c=>{
        c.width  = Math.round(W * scale);
        c.height = Math.round(H * scale);
        const ctx = c.getContext('2d');
        ctx.setTransform(scale,0,0,scale,0,0);
        ctx.imageSmoothingEnabled = false;
      });
      // container min boyu
      els.wrap.style.minHeight = (H*scale + 20) + "px";
    }

    function drawMaskFaint(img){
      const [W,H] = canvasWH();
      bgCtx.save();
      bgCtx.clearRect(0,0,W,H);
      bgCtx.globalAlpha = 0.18;
      bgCtx.imageSmoothingEnabled = false;
      bgCtx.drawImage(img, 0,0, W,H);
      bgCtx.restore();
    }

    function drawGrid(){
      const [W,H] = canvasWH();
      gridCtx.clearRect(0,0,W,H);

      // Hücreleri durumuna göre tonla
      for(let r=0; r<CFG.gridRows; r++){
        for(let c=0; c<CFG.gridCols; c++){
          const x = c*CFG.cellPx, y=r*CFG.cellPx;
          const key = r+"_"+c;
          const isTaken = taken.has(key);
          const isSel = selectable[r]?.[c];

          if(isTaken){
            gridCtx.fillStyle = "rgba(239,68,68,.45)"; // kırmızı
            gridCtx.fillRect(x,y,CFG.cellPx,CFG.cellPx);
          } else if(isSel){
            gridCtx.fillStyle = "rgba(14,165,233,.35)"; // mavi – seçilebilir
            gridCtx.fillRect(x,y,CFG.cellPx,CFG.cellPx);
          } else {
            // zemin (beyaz kısım) – hafif kapat
            gridCtx.fillStyle = "rgba(100,116,139,.08)";
            gridCtx.fillRect(x,y,CFG.cellPx,CFG.cellPx);
          }
        }
      }

      // Izgara
      gridCtx.strokeStyle = "rgba(55,65,81,.35)";
      gridCtx.lineWidth = 1;
      for(let c=0; c<=CFG.gridCols; c++){
        const x = c*CFG.cellPx + .5;
        gridCtx.beginPath(); gridCtx.moveTo(x,0); gridCtx.lineTo(x,H); gridCtx.stroke();
      }
      for(let r=0; r<=CFG.gridRows; r++){
        const y = r*CFG.cellPx + .5;
        gridCtx.beginPath(); gridCtx.moveTo(0,y); gridCtx.lineTo(W,y); gridCtx.stroke();
      }

      // Seçili hücreyi işaretle
      if(picked){
        gridCtx.strokeStyle = "#60a5fa";
        gridCtx.lineWidth = 2;
        gridCtx.strokeRect(picked[1]*CFG.cellPx+1, picked[0]*CFG.cellPx+1, CFG.cellPx-2, CFG.cellPx-2);
      }
    }

    function luminance(r,g,b){ return 0.2126*r + 0.7152*g + 0.0722*b; }

    function buildSelectableFromMask(){
      const [W,H] = canvasWH();
      const data = hitCtx.getImageData(0,0,W,H).data;
      selectable = Array.from({length:CFG.gridRows}, ()=>Array(CFG.gridCols).fill(false));

      for(let r=0; r<CFG.gridRows; r++){
        for(let c=0; c<CFG.gridCols; c++){
          const cx = Math.floor(c*CFG.cellPx + CFG.cellPx/2);
          const cy = Math.floor(r*CFG.cellPx + CFG.cellPx/2);
          const idx = (cy*W + cx) * 4;
          const R = data[idx], G = data[idx+1], B = data[idx+2], A = data[idx+3];
          if(A < 10){ selectable[r][c] = false; continue; }
          const L = luminance(R,G,B);
          // ~80 altını "siyah" say – logo siyah, zemin beyaz
          selectable[r][c] = (L < 80);
        }
      }
    }

    function drawAll(){ drawGrid(); }

    // ==== Etkileşimler
    els.grid.addEventListener('click', (ev)=>{
      const rect = els.grid.getBoundingClientRect();
      const x = (ev.clientX - rect.left) / scale;
      const y = (ev.clientY - rect.top) / scale;
      const c = Math.floor(x / CFG.cellPx);
      const r = Math.floor(y / CFG.cellPx);
      if(r<0||c<0||r>=CFG.gridRows||c>=CFG.gridCols) return;
      if(!selectable[r][c]) return;
      picked = [r,c];
      drawAll();
    });

    els.clearSel.addEventListener('click', ()=>{ picked=null; drawAll(); });
    els.zoomIn.addEventListener('click', ()=>{
      scale = Math.min(3, +(scale+0.1).toFixed(2));
      els.zoomPct.textContent = "%"+Math.round(scale*100);
      setCanvasSize(); drawAll();
    });
    els.zoomOut.addEventListener('click', ()=>{
      scale = Math.max(0.5, +(scale-0.1).toFixed(2));
      els.zoomPct.textContent = "%"+Math.round(scale*100);
      setCanvasSize(); drawAll();
    });

    els.placeBtn.addEventListener('click', ()=>{
      if(!picked) return alert("Önce logonun siyah alanından bir hücre seçin.");
      if(!els.username.value.trim()) return alert("Twitter kullanıcı adını girin.");
      if(!els.file.files[0]) return alert("Profil görselini yükleyin.");
      alert("Demo: Hücre ("+picked.join(",")+") rezerve edilmiş varsayıldı.");
    });

    // ==== Yardımcı: url çöz
    function resolveMaskUrl(raw) {
      if(!raw) return "/mask.png";
      const s = raw.trim();
      if (s.startsWith("http")) return s;
      if (s.startsWith("/")) return s;
      return "/" + s.replace(/^\.?\/+/, "");
    }

    // ==== Yükleme akışı
    (async ()=>{
      try{
        const snap = await getDoc(doc(db,'settings','config'));
        if(snap.exists()){
          const d = snap.data();
          CFG.cellPx   = +d.cellPx || CFG.cellPx;
          CFG.gridRows = +d.gridRows || CFG.gridRows;
          CFG.gridCols = +d.gridCols || CFG.gridCols;
          CFG.logoMaskUrl = resolveMaskUrl(d.logoMaskUrl || CFG.logoMaskUrl);
          CFG.mosaicOpen = d.mosaicOpen !== undefined ? !!d.mosaicOpen : true;
        } else {
          console.warn("Firestore: settings/config bulunamadı, varsayılanlarla devam.");
        }
      }catch(err){
        console.warn("Firestore okunamadı (devam ediliyor):", err?.message || err);
      }

      els.state.textContent = CFG.mosaicOpen ? "Açık" : "Kapalı";
      els.state.className = CFG.mosaicOpen ? "state-ok" : "state-off";

      setCanvasSize();  // tuvalleri hazırla

      // --- Maskeyi yükle
      const url = resolveMaskUrl(CFG.logoMaskUrl || "/mask.png");
      const finalUrl = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
      console.log("Mask URL (raw):", CFG.logoMaskUrl);
      console.log("Mask URL (resolved):", url);
      console.log("Mask URL (fetching):", finalUrl);

      // İsteğin atıldığını ve 200 döndüğünü teyit edelim
      try{
        const resp = await fetch(finalUrl, { cache:"no-store" });
        console.log("mask.png fetch status:", resp.status);
        if(!resp.ok){
          console.error("Mask fetch NG:", resp.status, finalUrl);
          return;
        }
      }catch(e){
        console.error("Mask fetch error:", e);
        return;
      }

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = ()=>{
        const [W,H] = canvasWH();

        // Hit-canvas’a tam çözünürlükte
        els.hit.width = W; els.hit.height = H;
        hitCtx.setTransform(1,0,0,1,0,0);
        hitCtx.imageSmoothingEnabled = false;
        hitCtx.clearRect(0,0,W,H);
        hitCtx.drawImage(img, 0,0, W,H);

        // Arkaplanı soluk çiz
        drawMaskFaint(img);

        // Seçilebilir haritayı oluştur
        buildSelectableFromMask();

        // İlk grid
        drawAll();
      };
      img.onerror = (e)=> console.error("Mask onerror:", e, finalUrl);
      img.src = finalUrl;
    })();
  </script>
</body>
</html>
