<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sentient Mosaic</title>
  <style>
    :root { --bg:#0a0a0a; --panel:#111318; --text:#e5e7eb; --muted:#9aa0a6; --accent:#6366f1; --logo:#0ea5e9; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:#000; color:var(--text); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      display:flex; flex-direction:column; align-items:center; gap:10px;
    }
    .toolbar{
      width:min(1200px, 95vw); display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:center;
      padding:10px; margin-top:8px; background:var(--panel); border:1px solid #1f2430; border-radius:10px;
    }
    .toolbar input[type="text"]{ background:#0f1115; color:var(--text); border:1px solid #242a36; border-radius:8px; padding:8px 10px; min-width:160px; }
    .toolbar input[type="file"]{ color:var(--muted) }
    .toolbar button{
      background:#5046e4; border:none; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600;
    }
    .toolbar .ghost{ background:#1b1e27; color:var(--text) }
    .hint{color:var(--muted); font-size:12px; text-align:center; margin-top:-2px}
    .stage{
      width:min(1200px, 95vw); background:#0b0b0b; border:1px dashed #2a2f3b; border-radius:12px; padding:8px;
      display:flex; justify-content:center; align-items:center; margin-bottom:12px;
    }
    canvas{ display:block; background:#000; border-radius:10px; }
    .legend{color:var(--muted); font-size:12px; text-align:center; margin-top:-6px}
    .status{font-size:12px; color:#fca5a5; text-align:center; min-height:18px}
  </style>

  <!-- Firebase (varsa) için compat SDK'lar; projende zaten varsa bu iki script kalabilir -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>
</head>
<body>

  <div class="toolbar">
    <input id="tw" type="text" placeholder="Twitter kullanıcı adı" />
    <input id="file" type="file" accept="image/*" />
    <input id="note" type="text" placeholder="Dobby'ye notun (128 karakter)" maxlength="128" style="flex:1; min-width:220px" />
    <button id="clearSel" class="ghost">Seçimi temizle</button>
    <button id="placeSel">Seçilen hücreye yerleştir</button>
  </div>
  <div class="hint">Bir hücre seçmek için mozaikte <b>logonun siyah alanına</b> tıkla.</div>

  <div class="stage">
    <canvas id="mosaic" aria-label="mosaic"></canvas>
  </div>
  <div id="status" class="status"></div>
  <div class="legend">Logo dışı alan siyah; logo pikselleri yuvarlatılmış daireler olarak çizilir. (Veri: <code>settings/config</code>)</div>

<script>
(async function(){
  // --- Varsayılan konfigürasyon (Firestore okunamazsa bunlar kullanılır) ---
  const DEFAULT_CFG = {
    gridCols: 40,
    gridRows: 40,
    cellPx: 16,
    logoMaskUrl: '/mask.png',
    mosaicOpen: true,
    maxClaimPerUser: 1
  };

  // Basit yardımcılar
  const $ = s => document.querySelector(s);
  const statusEl = $('#status');
  const canvas = $('#mosaic');
  const ctx = canvas.getContext('2d', { willReadFrequently:true });

  // --- Konfigürasyonu yükle (Firestore varsa), yoksa fallback ---
  let cfg = { ...DEFAULT_CFG };
  let cfgSource = 'fallback';
  try {
    // Projende zaten initializeApp yapılıysa kullanır. Yapılmadıysa hiçbir şey yapmaz.
    if (window.firebase && firebase.apps && firebase.apps.length) {
      const db = firebase.firestore();
      const snap = await db.collection('settings').doc('config').get();
      if (snap.exists) { Object.assign(cfg, snap.data()); cfgSource = 'firestore'; }
    }
  } catch (e) {
    console.warn('Firestore config okunamadı:', e);
  }
  console.log('CFG source:', cfgSource);
  console.log('Mask URL:', cfg.logoMaskUrl);

  // --- Tuval boyutu ve merkezleme ---
  function setCanvasSize() {
    // İç boyut: gerçek piksel ızgarası
    canvas.width  = cfg.gridCols * cfg.cellPx;
    canvas.height = cfg.gridRows * cfg.cellPx;

    // Ekrana sığacak şekilde CSS ölçüsü (görüntü ölçeği)
    const maxW = Math.min(window.innerWidth * 0.95, 1100);
    const scale = Math.min(1, maxW / canvas.width);
    canvas.style.width  = (canvas.width  * scale) + 'px';
    canvas.style.height = (canvas.height * scale) + 'px';
  }
  setCanvasSize();
  addEventListener('resize', setCanvasSize);

  // --- Arkaplanı boya ---
  function paintBackground(){
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,canvas.width, canvas.height);
  }

  // --- Mask resmi -> boolean grid (rows x cols) ---
  function imageToGrid(img, rows, cols){
    const t = document.createElement('canvas');
    t.width = cols; t.height = rows;
    const tctx = t.getContext('2d', { willReadFrequently:true });
    tctx.imageSmoothingEnabled = false;
    tctx.drawImage(img, 0, 0, cols, rows);

    const data = tctx.getImageData(0,0,cols,rows).data;
    const grid = new Array(rows).fill(0).map(()=> new Array(cols).fill(false));

    for (let y=0; y<rows; y++){
      for (let x=0; x<cols; x++){
        const i = (y*cols + x) * 4;
        const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
        // "Siyah & opak" pikselleri logo kabul ediyoruz
        const luminance = 0.2126*r + 0.7152*g + 0.0722*b;
        const isLogo = (a > 40) && (luminance < 100);
        grid[y][x] = !!isLogo;
      }
    }
    return grid;
  }

  // --- Grid’i çiz (logo = daireler, zemin = siyah) ---
  function drawGrid(grid){
    const cell = cfg.cellPx;
    paintBackground();

    // Logo pikselleri
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--logo').trim() || '#0ea5e9';
    for (let y=0; y<cfg.gridRows; y++){
      for (let x=0; x<cfg.gridCols; x++){
        if (!grid[y][x]) continue;
        const cx = x*cell + cell/2;
        const cy = y*cell + cell/2;
        const r  = Math.floor(cell*0.45);
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI*2);
        ctx.fill();
      }
    }

    // İnce grid çizgileri (isteğe bağlı)
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 1;
    for (let x=0; x<=cfg.gridCols; x++){ ctx.beginPath(); ctx.moveTo(x*cell,0); ctx.lineTo(x*cell,canvas.height); ctx.stroke(); }
    for (let y=0; y<=cfg.gridRows; y++){ ctx.beginPath(); ctx.moveTo(0,y*cell); ctx.lineTo(canvas.width,y*cell); ctx.stroke(); }
  }

  // --- Maskeyi yükle ve çiz ---
  async function loadAndRenderMask(){
    return new Promise((resolve) => {
      statusEl.textContent = '';
      paintBackground();

      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        console.log('Mask loaded:', img.width, 'x', img.height);
        const grid = imageToGrid(img, cfg.gridRows, cfg.gridCols);
        drawGrid(grid);
        resolve(true);
      };
      img.onerror = () => {
        const msg = 'Mask yüklenemedi: ' + cfg.logoMaskUrl;
        console.error(msg);
        statusEl.textContent = msg;
        paintBackground(); // siyah bırak
        resolve(false);
      };
      img.src = cfg.logoMaskUrl || '/mask.png';
    });
  }

  // İlk çizim
  await loadAndRenderMask();

  // --- Basit buton işlevleri (şimdilik görsel/demonstratif) ---
  $('#clearSel').onclick  = () => statusEl.textContent = 'Seçim temizlendi (demo).';
  $('#placeSel').onclick  = () => statusEl.textContent = 'Seçim yerleştirildi (demo).';
  $('#file').onchange     = () => statusEl.textContent = 'Dosya seçildi: ' + ($('#file').files[0]?.name ?? '');
})();
</script>
</body>
</html>
